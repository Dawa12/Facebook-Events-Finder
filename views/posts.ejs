<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Liked Page</title>
    <link rel="stylesheet" href="/index.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript"></script>
  </head>
  <body>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.8&appId=1843900205894102";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

    <script type="text/javascript">
      $(document).ready(function () {
            window.fbAsyncInit = function() {
              FB.init({
                appId      : '1843900205894102',
                status: true,
                cookie: true,
                xfbml      : true,
                version    : 'v2.8'
              });

              FB.AppEvents.logPageView();

              FB.login(function(response) {
              // handle the response
                window.location.reload();
                console.log('reloading page....');
              }, {scope: 'email,user_likes'});

              // do FB get calls inside of getLoginStatus method
              // source: http://stackoverflow.com/questions/26709869/an-active-access-token-must-be-used-to-query-information-about-the-current-user
              // once user is logged in, execute this large block
              FB.getLoginStatus(function(response) {
                  if (response.status === 'connected') {
                    $('.fb-login-button').hide()
                    $('#fbLogout').show()

                    FB.api('/me', 'GET', {fields: 'likes.limit(10){about,category,category_list,description,events.limit(2)},first_name,last_name,name,id,picture.width(150).height(150)'}, function(response) {
console.log('response', response);
                      let likes_array = response.likes.data

                    let flex_parent = document.createElement("div")
                    flex_parent.className = "flex-parent"
                    let heading = document.createElement('h2')
                    heading.textContent = "Showing Upcoming Events"
                    document.body.appendChild(heading)


                    loop_events(likes_array)
                    document.body.appendChild(flex_parent)

                    // Loop through all events
                    function loop_events(events) {
                      for (let i = 0; i < likes_array.length; i++) {
                        let event_name = document.createElement("P");
                        event_name.className = "event_name"
                        // console.log('event_name', event_name);
                        let location = document.createElement("P");
                        let name = document.createElement("P");

                        if (likes_array[i].events) {// console.log('inside if true');
                          event_name.textContent = 'Event: ' + likes_array[i].events.data[0].name
                          if (likes_array[i].events.data[0].place) {
                            location.textContent = 'Location: ' + likes_array[i].events.data[0].place.name
                          } else {
                            //  continue
                          }
                        } else {
        //  console.log('inside if false');
        //  console.log('no events for ', likes_array[i].about);
                        }

                        var hold_name;
                        let page_picture = document.createElement("IMG");
                        let container = $('<div/>').addClass('container')
                        let parent = document.createElement("div")
                        parent.className = "parent"

                        getPageName()

                        function getPageName() {
                          FB.api(
                            `/${likes_array[i].id}?fields=picture,name`,
                            function (response) {
                              if (response && !response.error) {
                                hold_name = response.name
                                page_picture.setAttribute("src", response.picture.data.url)
                                parent.appendChild(page_picture)
                              }
                              // Append Elements to document.body
                              appendElementsToDocument(likes_array)
                            }
                          )
                        }

                        function appendElementsToDocument(arr) {
                          name.textContent = 'Name: ' + hold_name
                          // console.log('name', name);

                          if (!(name.textContent.length == 0)) {
                            // document.body.appendChild(name);
                            parent.appendChild(name)
                            // $('.container').append(name)
console.log('container', container);

                          }
                          if (!(event_name.textContent.length == 0)) {
                            // document.body.append(event_name);
                            parent.appendChild(event_name)
                          }

                          if (!(location.textContent.length == 0)) {
                            // document.body.append(location);
                            // $('.container').append(location)
                            parent.appendChild(location)
                          }

console.log('arr[i]', arr[i]);
      let link = document.createElement('a')
      link.setAttribute('href', `https://www.facebook.com/events/${arr[i].events.data[0].id}`)
      link.textContent = "Go to Event Page"
      parent.appendChild(link)

      flex_parent.appendChild(parent)
      // document.body.appendChild(separator)

                          // $('body').append(container)
                        }
        // closing for loop block
                      }
                    }

        // closing FB.api('/me'
                    })
                  // closing FB.login conditional
                  } else {
        console.log('initiate FB login...');
        console.log('Try logging in again, or reloading page to show events');


        $('.fb-login-button').show()
        $('#fbLogout').hide()
                    // FB.loginStatus if condition
                  }
              // closing FB.getLoginStatus function
                });
              // closing window.fbAsyncInit
            };

            // reference for logout button: https://github.com/tomero/JS-Facebook-Login-SDK/blob/master/index.html#L106
            $('#fbLogout').click(function() {
              FB.getLoginStatus(function (response) {
                if (response.authResponse) {
                  var uid = response.authResponse.userID;
                  var accessToken = response.authResponse.accessToken;
                  FB.logout(function (response) {
                    console.log(response);
                    window.location.reload();
                  });
                } else {

                }
              });
            });
      })
    </script>

    <div>
      <h1 id="head">Fan Page Events</h1>
    </div>
    <!-- <span id="fbLogout"><a class="fb_button fb_button_medium"><span class="fb_button_text">Logout</span></a></span> -->


    <img id="fbLogout"src="logout.png" alt="logout">

    <div class="fb-login-button" data-max-rows="1" data-size="medium" data-show-faces="false" data-auto-logout-link="false" onlogin="window.location.reload()"></div>

  </body>
</html>
